-- Update: 02/26/2024 Inducted = Total Sorter Fed - Rework
SELECT
    MPE_NAME,
    HR
    ||':00'                         AS HOUR,
    0 AS SORTED,
    0 AS REJECTED,
    NVL(SORTED, 0)+NVL(REJECTED, 0) AS INDUCTED
FROM
    (
        SELECT
            S.MPE_NAME,
            S.HR,
            S.RESULT,
            SUM(S.COUNT) AS TOTAL
        FROM
            (
                SELECT /*+ PARALLEL(U, 16)*/
                    L.MPE_NAME,
                    (
                        CASE
                            WHEN U.POCKETNUM = 401 OR U.POCKETNUM = 404 THEN
                                'Reworked'
                            WHEN U.POCKETNUM >= 198 OR U.POCKETNUM <= 2 OR U.ZIP ='NOREAD' THEN
                                'Rejected'
                            ELSE
                                'Sorted'
                        END)AS                                RESULT,
                    TO_CHAR(U.DATA_DATE, 'yyyy-mm-dd hh24') AS HR,
                    COUNT(*)                                AS COUNT
                FROM
                    DCSDBA.GENMP    U,
                    DCSDBA.MPE_LIST L
                WHERE
                    U.MPE_ID IN (
                        SELECT
                            MPE_ID
                        FROM
                            DCSDBA.MPE_LIST
                        WHERE
                            MPE_TYPE IN ('HOPS')
                    )
                    AND U.DATA_DATE>= TRUNC(SYSDATE, 'HH') -(:STARTHOUR-1)/24
                    AND U.DATA_DATE< TRUNC(SYSDATE, 'HH') -(:STARTHOUR-1)/24 +(:ENDHOUR)/24
                    AND U.MPE_ID = L.MPE_ID
                GROUP BY
                    L.MPE_NAME,
                    (
                        CASE
                            WHEN U.POCKETNUM = 401 OR U.POCKETNUM = 404 THEN
                                'Reworked'
                            WHEN U.POCKETNUM >= 198 OR U.POCKETNUM <= 2 OR U.ZIP ='NOREAD' THEN
                                'Rejected'
                            ELSE
                                'Sorted'
                        END),
                    TO_CHAR(U.DATA_DATE, 'yyyy-mm-dd hh24')
                ORDER BY
                    HR
            )S
        GROUP BY
            MPE_NAME,
            HR,
            RESULT
        ORDER BY
            MPE_NAME,
            HR,
            RESULT
    ) PIVOT ( MIN(TOTAL) FOR (RESULT) IN ('Sorted' AS SORTED,
    'Rejected' AS REJECTED,
    'Reworked' AS REWORKED) )
ORDER BY
    MPE_NAME,
    HOUR