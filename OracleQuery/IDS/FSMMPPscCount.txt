-- Update: 03/01/2024
-- Sorted is matching WebEOR
-- Rejected is Rejected + Phantom Rejects
-- Inducted is Fed + Phantom Rejects
-- No way to exclude Phantom Rejects for now 
SELECT
    MPE_NAME,
    HR
    ||':00'                         AS HOUR,
    NVL(SORTED, 0)                  AS SORTED,
    NVL(REJECTED, 0)                AS REJECTED,
    NVL(SORTED, 0)+NVL(REJECTED, 0) AS INDUCTED
FROM
    (
        SELECT
            S.MPE_NAME,
            S.HR,
            S.RESULT,
            SUM(S.COUNT) AS "TOTAL"
        FROM
            (
                SELECT /*+ PARALLEL(F, 16)*/
                    L.MPE_NAME,
                    (
                        CASE
                            WHEN F.SORTINFO IN (1, 2, 3) THEN
                                'Sorted'
                            ELSE
                                'Rejected'
                        END)AS                                RESULT,
                    TO_CHAR(F.DATA_DATE, 'yyyy-mm-dd hh24') AS HR,
                    COUNT(*)                                AS COUNT
                FROM
                    DCSDBA.FSMMP    F,
                    DCSDBA.MPE_LIST L
                WHERE
                    F.MPE_ID IN (
                        SELECT
                            MPE_ID
                        FROM
                            DCSDBA.MPE_LIST
                        WHERE
                            MPE_TYPE IN ('AFSM100')
                    )
                    AND F.DATA_DATE>= TRUNC(SYSDATE, 'HH') -(:STARTHOUR-1)/24
                    AND F.DATA_DATE< TRUNC(SYSDATE, 'HH') -(:STARTHOUR-1)/24 +(:ENDHOUR)/24
                    AND F.MPE_ID = L.MPE_ID
                GROUP BY
                    L.MPE_NAME,
                    (
                        CASE
                            WHEN F.SORTINFO IN (1, 2, 3) THEN
                                'Sorted'
                            ELSE
                                'Rejected'
                        END),
                    TO_CHAR(F.DATA_DATE, 'yyyy-mm-dd hh24')
                ORDER BY
                    HR
            )S
        GROUP BY
            MPE_NAME,
            HR,
            RESULT
        ORDER BY
            MPE_NAME,
            HR,
            RESULT
    ) PIVOT ( MIN(TOTAL) FOR (RESULT) IN ('Sorted' AS SORTED,
    'Rejected' AS REJECTED) )
ORDER BY
    MPE_NAME,
    HOUR